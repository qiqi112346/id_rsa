<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no"/>
    <title>泰森多边形</title>
    <!--加载不同版本Cesium库-->
    <script src="http://webclient.smaryun.com/static/libs/loadCesium.js"></script>
    <!--plugin脚本库-->
    <script src="http://webclient.smaryun.com/static/libs/cdn/zondyclient/webclient-common.min.js"></script>
    <script src="http://webclient.smaryun.com/static/libs/cdn/zondyclient/webclient-cesium-plugin.min.js"></script>
    <script src="http://webclient.smaryun.com/static/assets/js/TDT-token.js"></script>

    <!--turf.js库-->
    <script src="http://webclient.smaryun.com/static/libs/cdn/turf/turf.min.js"></script>
    <!--示例中面板、按钮等，第三方layui的js库与css样式-->
    <script src="http://webclient.smaryun.com/static/libs/cdn/layui/layui.js"></script>
    <link rel="stylesheet" href="http://webclient.smaryun.com/static/libs/cdn/layui/css/layui.css"/>
    <!--示例公共样式-->
    <link rel="stylesheet" href="http://webclient.smaryun.com/static/libs/css/style.css"/>
   <link rel="stylesheet" href="http://webclient.smaryun.com/static/libs/css/analyse.css"/>
    <script>
      'use strict'
      let map, sceneView, viewer
      let dataSource
      //点位数据
      let data = {
        type: 'FeatureCollection',
        features: [
          {
            type: 'Feature',
            properties: { mpLayer: 0 },
            geometry: {
              type: 'Point',
              coordinates: [113.969705349690571, 30.4385415882922814]
            }
          },
          {
            type: 'Feature',
            properties: { mpLayer: 0 },
            geometry: {
              type: 'Point',
              coordinates: [114.234228759020411, 30.2845152993154159]
            }
          },
          {
            type: 'Feature',
            properties: { mpLayer: 0 },
            geometry: {
              type: 'Point',
              coordinates: [114.488706975590873, 30.3632026425970736]
            }
          },
          {
            type: 'Feature',
            properties: { mpLayer: 0 },
            geometry: {
              type: 'Point',
              coordinates: [114.217207999999971, 30.483413000000013]
            }
          },
          {
            type: 'Feature',
            properties: { mpLayer: 0 },
            geometry: {
              type: 'Point',
              coordinates: [114.309567704715604, 30.7650103529715047]
            }
          },
          {
            type: 'Feature',
            properties: { mpLayer: 0 },
            geometry: {
              type: 'Point',
              coordinates: [114.56739431887253, 30.6779520157237116]
            }
          },
          {
            type: 'Feature',
            properties: { mpLayer: 0 },
            geometry: {
              type: 'Point',
              coordinates: [114.850333914927859, 30.8654622805651115]
            }
          },
          {
            type: 'Feature',
            properties: { mpLayer: 0 },
            geometry: {
              type: 'Point',
              coordinates: [114.329658090234332, 30.9290818347077305]
            }
          },
          {
            type: 'Feature',
            properties: { mpLayer: 0 },
            geometry: {
              type: 'Point',
              coordinates: [114.354771072132735, 30.3113024800070434]
            }
          },
          {
            type: 'Feature',
            properties: { mpLayer: 0 },
            geometry: {
              type: 'Point',
              coordinates: [114.319412, 30.5983660000000128]
            }
          },
          {
            type: 'Feature',
            properties: { mpLayer: 0 },
            geometry: {
              type: 'Point',
              coordinates: [114.573634999999967, 30.6080240000000217]
            }
          },
          {
            type: 'Feature',
            properties: { mpLayer: 0 },
            geometry: {
              type: 'Point',
              coordinates: [114.073035171287813, 30.7456136124539299]
            }
          },
          {
            type: 'Feature',
            properties: { mpLayer: 0 },
            geometry: {
              type: 'Point',
              coordinates: [114.105480381866897, 30.3799810470818379]
            }
          },
          {
            type: 'Feature',
            properties: { mpLayer: 0 },
            geometry: {
              type: 'Point',
              coordinates: [114.569696471690847, 30.2364733849050786]
            }
          },
          {
            type: 'Feature',
            properties: { mpLayer: 0 },
            geometry: {
              type: 'Point',
              coordinates: [114.826762370894443, 30.3487837292173239]
            }
          },
          {
            type: 'Feature',
            properties: { mpLayer: 0 },
            geometry: {
              type: 'Point',
              coordinates: [114.436171951230733, 30.4473672536691851]
            }
          },
          {
            type: 'Feature',
            properties: { mpLayer: 0 },
            geometry: {
              type: 'Point',
              coordinates: [114.41745356051203, 30.592122808560525]
            }
          },
          {
            type: 'Feature',
            properties: { mpLayer: 0 },
            geometry: {
              type: 'Point',
              coordinates: [114.620860072988648, 30.4361362192379623]
            }
          },
          {
            type: 'Feature',
            properties: { mpLayer: 0 },
            geometry: {
              type: 'Point',
              coordinates: [114.696981528578064, 30.3462879437881661]
            }
          },
          {
            type: 'Feature',
            properties: { mpLayer: 0 },
            geometry: {
              type: 'Point',
              coordinates: [114.783086125884125, 30.4648377516733149]
            }
          },
          {
            type: 'Feature',
            properties: { mpLayer: 0 },
            geometry: {
              type: 'Point',
              coordinates: [114.654553176282334, 30.5372155291189813]
            }
          },
          {
            type: 'Feature',
            properties: { mpLayer: 0 },
            geometry: {
              type: 'Point',
              coordinates: [114.740657773588381, 30.6570132297187108]
            }
          },
          {
            type: 'Feature',
            properties: { mpLayer: 0 },
            geometry: {
              type: 'Point',
              coordinates: [114.760624057021673, 30.7680756813163789]
            }
          },
          {
            type: 'Feature',
            properties: { mpLayer: 0 },
            geometry: {
              type: 'Point',
              coordinates: [114.538499153826336, 30.831718209759984]
            }
          },
          {
            type: 'Feature',
            properties: { mpLayer: 0 },
            geometry: {
              type: 'Point',
              coordinates: [114.444907200232805, 30.7393741488810264]
            }
          },
          {
            type: 'Feature',
            properties: { mpLayer: 0 },
            geometry: {
              type: 'Point',
              coordinates: [114.2078075844625, 30.6420385171437459]
            }
          },
          {
            type: 'Feature',
            properties: { mpLayer: 0 },
            geometry: {
              type: 'Point',
              coordinates: [114.090505669291943, 30.5347197436898234]
            }
          },
          {
            type: 'Feature',
            properties: { mpLayer: 0 },
            geometry: {
              type: 'Point',
              coordinates: [114.15913976859386, 30.2639270246258505]
            }
          },
          {
            type: 'Feature',
            properties: { mpLayer: 0 },
            geometry: {
              type: 'Point',
              coordinates: [114.172866588454255, 30.7730672521746982]
            }
          },
          {
            type: 'Feature',
            properties: { mpLayer: 0 },
            geometry: {
              type: 'Point',
              coordinates: [114.137925592445995, 30.9652427302200977]
            }
          },
          {
            type: 'Feature',
            properties: { mpLayer: 0 },
            geometry: {
              type: 'Point',
              coordinates: [114.271450112906109, 30.8766423474848821]
            }
          },
          {
            type: 'Feature',
            properties: { mpLayer: 0 },
            geometry: {
              type: 'Point',
              coordinates: [114.456138234664024, 30.862915527624498]
            }
          },
          {
            type: 'Feature',
            properties: { mpLayer: 0 },
            geometry: {
              type: 'Point',
              coordinates: [114.597150111411622, 30.9664906229346784]
            }
          },
          {
            type: 'Feature',
            properties: { mpLayer: 0 },
            geometry: {
              type: 'Point',
              coordinates: [114.709460455723871, 30.850436600478691]
            }
          },
          {
            type: 'Feature',
            properties: { mpLayer: 0 },
            geometry: {
              type: 'Point',
              coordinates: [114.635834785563617, 30.6969457965852897]
            }
          },
          {
            type: 'Feature',
            properties: { mpLayer: 0 },
            geometry: {
              type: 'Point',
              coordinates: [114.819275014606959, 30.5659170615543339]
            }
          },
          {
            type: 'Feature',
            properties: { mpLayer: 0 },
            geometry: {
              type: 'Point',
              coordinates: [114.558465437259628, 30.4985308549669867]
            }
          },
          {
            type: 'Feature',
            properties: { mpLayer: 0 },
            geometry: {
              type: 'Point',
              coordinates: [114.35755471021217, 30.45610250267125]
            }
          },
          {
            type: 'Feature',
            properties: { mpLayer: 0 },
            geometry: {
              type: 'Point',
              coordinates: [114.438667736659895, 30.2726622736279154]
            }
          },
          {
            type: 'Feature',
            properties: { mpLayer: 0 },
            geometry: {
              type: 'Point',
              coordinates: [114.315126357916427, 30.2327297067613365]
            }
          },
          {
            type: 'Feature',
            properties: { mpLayer: 0 },
            geometry: {
              type: 'Point',
              coordinates: [114.715699919296767, 30.2414649557634014]
            }
          },
          {
            type: 'Feature',
            properties: { mpLayer: 0 },
            geometry: {
              type: 'Point',
              coordinates: [114.14541294873348, 30.8154956044704385]
            }
          }
        ]
      }

      //初始化
      function init() {
        // 地图初始化
        initViewer()
        //创建切换Cesium版本的按钮
        createChangeTab()
        //加载天地图
        addTDT()
        //飞到指定视角
        flyTo()
        //加载原始的点数据
        loadOriginData()
      }

      //初始化球体
      function initViewer() {
        //初始化图层管理容器
        map = new zondy.Map()
        //初始化地图视图对象
        sceneView = new zondy.cesium.SceneView({
          //视图id
          viewId: 'mapgis-3d-viewer',
          //图层管理容器
          map: map
        })
        //获取视图对象
        viewer = sceneView.getInnerView()
      }

      //加载天地图
      function addTDT() {
        let TDTLayer = new zondy.layer.WMTSLayer({
          // 加载经纬度的影像地图
          url: 'http://t6.tianditu.gov.cn/img_c/wmts',
          // 天地图必须加token，且token名为tk
          tokenKey: 'tk',
          // token请在天地图官网申请
          tokenValue: getTDTToken()
        })
        map.add(TDTLayer)
      }

      //设置相机位置
      function flyTo() {
        //飞到指定视角
        sceneView.flyTo({
          center: [114.289398, 30.59418345, 500000.0]
        })
      }

      //准备点要素数据
      function loadOriginData() {
        viewer.dataSources.add(
          Cesium.GeoJsonDataSource.load(data, {
            //marker大小
            markerSize: 15
          })
        )
      }
      //点击泰森多边形分析
      function voronoi() {
        voronoiSource().then((res) => {
          //保存结果资源，移除时使用
          dataSource = res
        })
      }

      //泰森多边形分析
      function voronoiSource() {
        //先移除之前的分析结果
        if (dataSource) {
          viewer.dataSources.remove(dataSource)
        }
        //turf.voronoi分析
        let geoJson = turf.voronoi(data, {
          //bbox：裁剪框，特别重要，一定要包含所有的点，要不然无法生成泰森多边形，换言之，这个矩形的范围要够大
          bbox: [113.67, 30.0, 115.2, 31.41]
        })
        //添加分析结果
        let source = viewer.dataSources.add(
          Cesium.GeoJsonDataSource.load(geoJson, {
            //折线和多边形轮廓的颜色
            stroke: Cesium.Color.YELLOW.withAlpha(0.5),
            //多边形内部颜色，这里给一个透明度，否则轮廓会被覆盖
            fill: Cesium.Color.YELLOW.withAlpha(0.2),
            //折线和多边形轮廓宽度
            strokeWidth: 1,
            //设置指定多边形是否为轮廓的属性，不设置true，轮廓不显示
            outline: true
          })
        )
        //视角飞行
        viewer.flyTo(source)
        return source
      }
    </script>
  </head>

  <body onload="init()">
    <div id="mapgis-3d-viewer"></div>
    <div class="layui-panel layui-panel-right" style="width: 142px">
      <form class="layui-form" action="">
        <div class="sample-button-panel">
          <button
            type="button"
            class="layui-btn layui-btn-sm layui-btn-normal"
            onclick="voronoi()"
          >
            泰森多边形分析
          </button>
        </div>
      </form>
    </div>
  </body>
</html>
